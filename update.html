<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KingSignals Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-sha256/0.9.0/sha256.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700&family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#1E3A8A',
                        secondary: '#3B82F6',
                        accent: '#00FF00',
                        danger: '#F87171',
                        success: '#34D399',
                        warning: '#FBBF24',
                    },
                    animation: {
                        'glow': 'glow 0.8s ease-in-out infinite alternate',
                        'fade-in': 'fadeIn 0.5s ease-out',
                        'pulse': 'pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    },
                    keyframes: {
                        glow: {
                            '0%': { boxShadow: '0 0 8px rgba(0, 255, 0, 0.6), inset 0 0 8px rgba(0, 255, 0, 0.6)' },
                            '100%': { boxShadow: '0 0 30px rgba(0, 255, 0, 0.9), inset 0 0 30px rgba(0, 255, 0, 0.9)' },
                        },
                        fadeIn: {
                            '0%': { opacity: '0', transform: 'translateY(20px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        },
                        pulse: {
                            '0%, 100%': { opacity: '1' },
                            '50%': { opacity: '0.5' },
                        },
                    },
                    fontFamily: {
                        cairo: ['Cairo', 'sans-serif'],
                        orbitron: ['Orbitron', 'sans-serif'],
                    },
                },
            },
        }
    </script>
    <style>
        body {
            background: #000000;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            font-family: 'Cairo', sans-serif;
            overflow: hidden;
        }
        #login-container {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            background: url('data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1440 320"%3E%3Cpath fill="%2300FF00" fill-opacity="0.1" d="M0,160L48,186.7C96,213,192,267,288,261.3C384,256,480,192,576,181.3C672,171,768,213,864,213.3C960,213,1056,171,1152,154.7C1248,139,1344,149,1392,154.7L1440,160L1440,320L1392,320C1344,320,1248,320,1152,320C1056,320,960,320,864,320C768,320,672,320,576,320C480,320,384,320,288,320C192,320,96,320,48,320L0,320Z"%3E%3C/path%3E%3C/svg%3E') no-repeat center bottom;
        }
        .glassmorphism {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }
        .widget-container {
            margin: 0 auto;
            border-radius: 12px;
            overflow: hidden;
            width: 317px;
            height: 467px;
            position: relative;
            z-index: 1;
            background: radial-gradient(circle at center, rgba(255, 255, 255, 0.1) 0%, rgba(0, 0, 0, 0.8) 70%, #000000 100%);
            box-shadow: 0 0 20px rgba(0, 255, 0, 0.3);
        }
        .widget-wrapper {
            position: relative;
            width: 100%;
            height: 100%;
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid rgba(0, 255, 0, 0.2);
        }
        .gradient-text {
            background: linear-gradient(90deg, #FFD700, #00FF00);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        h1 {
            font-family: 'Orbitron', sans-serif;
        }
        .sidebar {
            position: fixed;
            top: 0;
            right: -300px;
            width: 300px;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            backdrop-filter: blur(10px);
            transition: right 0.3s ease-in-out;
            z-index: 1000;
            padding: 20px;
            box-shadow: -5px 0 15px rgba(0, 255, 0, 0.2);
            overflow-y: auto;
        }
        .sidebar.open {
            right: 0;
        }
        .hamburger {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1100;
            cursor: pointer;
            padding: 10px;
            background: rgba(0, 0, 0, 0.8);
            border-radius: 8px;
            border: 1px solid rgba(0, 255, 0, 0.3);
        }
        .hamburger span {
            display: block;
            width: 25px;
            height: 3px;
            background: #00FF00;
            margin: 5px 0;
            transition: all 0.3s ease-in-out;
        }
        .currency-button {
            display: flex;
            align-items: center;
            width: 100%;
            padding: 10px;
            margin: 5px 0;
            background: rgba(0, 255, 0, 0.1);
            border: 1px solid rgba(0, 255, 0, 0.3);
            border-radius: 5px;
            color: white;
            text-align: center;
            cursor: pointer;
            transition: background 0.3s, box-shadow 0.3s;
        }
        .currency-button:hover {
            background: rgba(0, 255, 0, 0.3);
            box-shadow: 0 0 10px rgba(0, 255, 0, 0.5);
        }
        .currency-button.active {
            background: rgba(0, 255, 0, 0.5);
            box-shadow: 0 0 15px rgba(0, 255, 0, 0.7);
        }
        .favorite-star {
            position: absolute;
            right: 10px;
            cursor: pointer;
            font-size: 20px;
        }
        .favorite-star.favorited::after {
            content: '★';
            color: #FFD700;
        }
        .favorite-star:not(.favorited)::after {
            content: '☆';
            color: #FFFFFF;
        }
        .auto-update-container {
            margin-top: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .auto-update-input {
            width: 60px;
            padding: 5px;
            background: rgba(0, 0, 0, 0.8);
            border: 1px solid rgba(0, 255, 0, 0.3);
            border-radius: 5px;
            color: white;
            text-align: center;
        }
        .auto-update-button, .pause-resume-button {
            flex-grow: 1;
            padding: 10px;
            background: rgba(0, 255, 0, 0.1);
            border: 1px solid rgba(0, 255, 0, 0.3);
            border-radius: 5px;
            color: white;
            text-align: center;
            cursor: pointer;
            transition: background 0.3s, box-shadow 0.3s;
        }
        .auto-update-button:hover, .pause-resume-button:hover {
            background: rgba(0, 255, 0, 0.3);
            box-shadow: 0 0 10px rgba(0, 255, 0, 0.5);
        }
        .auto-update-button.active, .pause-resume-button.active {
            background: rgba(0, 255, 0, 0.5);
            box-shadow: 0 0 15px rgba(0, 255, 0, 0.7);
        }
        .language-toggle, .favorites-toggle, .user-details-toggle {
            display: block;
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            background: rgba(0, 255, 0, 0.1);
            border: 1px solid rgba(0, 255, 0, 0.3);
            border-radius: 5px;
            color: white;
            text-align: center;
            cursor: pointer;
            transition: background 0.3s, box-shadow 0.3s;
        }
        .language-toggle:hover, .favorites-toggle:hover, .user-details-toggle:hover {
            background: rgba(0, 255, 0, 0.3);
            box-shadow: 0 0 10px rgba(0, 255, 0, 0.5);
        }
        .user-details {
            display: none;
            background: rgba(0, 0, 0, 0.8);
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
            color: white;
        }
        .user-details.open {
            display: block;
        }
        .current-currency {
            margin-bottom: 10px;
            color: #FFFFFF;
            font-weight: bold;
            text-align: center;
            font-size: 16px;
        }
        .countdown-timer {
            margin-top: 10px;
            color: #FFFFFF;
            font-weight: bold;
            text-align: center;
            font-size: 16px;
        }
        .refresh-button {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 3;
            padding: 8px;
            background: rgba(0, 255, 0, 0.1);
            border: 1px solid rgba(0, 255, 0, 0.3);
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.3s, box-shadow 0.3s;
        }
        .refresh-button:hover {
            background: rgba(0, 255, 0, 0.3);
            box-shadow: 0 0 10px rgba(0, 255, 0, 0.5);
        }
        .usage-instructions {
            font-size: 14px;
            text-align: center;
            color: #FFFFFF;
            margin-top: 15px;
            line-height: 1.6;
        }
        .usage-instructions p {
            margin-bottom: 10 PX;
            color: #FFFFFF;
        }
        .usage-instructions ul li {
            color: #FFFFFF;
            text-align: right;
        }
        .green-text {
            color: #34D399;
            font-weight: bold;
        }
        .red-text {
            color: #F87171;
            font-weight: bold;
        }
        .login-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 20px;
            animation: fade-in 0.5s ease-out;
        }
        .login-form {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(15px);
            border-radius: 20px;
            padding: 40px;
            width: 100%;
            max-width: 400px;
            box-shadow: 0 0 50px rgba(0, 255, 0, 0.5);
            border: 2px solid rgba(0, 255, 0, 0.3);
            position: relative;
            overflow: hidden;
        }
        .login-form::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(0, 255, 0, 0.2) 0%, transparent 70%);
            animation: pulse 10s infinite;
            z-index: -1;
        }
        .login-form input {
            width: 100%;
            padding: 14px;
            margin: 10px 0;
            background: rgba(0, 0, 0, 0.9);
            border: 1px solid rgba(0, 255, 0, 0.4);
            border-radius: 10px;
            color: white;
            font-family: 'Cairo', sans-serif;
            transition: border-color 0.3s, box-shadow 0.3s;
        }
        .login-form input:focus {
            outline: none;
            border-color: #00FF00;
            box-shadow: 0 0 15px rgba(0, 255, 0, 0.7);
        }
        .login-form button.register-button {
            width: 100%;
            padding: 16px;
            margin: 20px 0;
            background: linear-gradient(90deg, #00FF00, #FFD700);
            border: none;
            border-radius: 10px;
            color: black;
            font-weight: bold;
            font-family: 'Cairo', sans-serif;
            cursor: pointer;
            position: relative;
            overflow: hidden;
            transition: transform 0.3s, box-shadow 0.3s;
        }
        .login-form button.register-button::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
            transition: 0.5s;
        }
        .login-form button.register-button:hover:not(:disabled)::after {
            left: 100%;
        }
        .login-form button.register-button:hover:not(:disabled) {
            transform: scale(1.05);
            box-shadow: 0 0 25px rgba(0, 255, 0, 0.8);
        }
        .login-form button.register-button:disabled {
            background: rgba(0, 255, 0, 0.3);
            cursor: not-allowed;
        }
        .login-link {
            display: block;
            text-align: center;
            color: #34D399;
            font-family: 'Cairo', sans-serif;
            margin-top: 15px;
            font-size: 16px;
            transition: color 0.3s;
        }
        .login-link:hover {
            color: #FFD700;
        }
        .error-message, .validation-message {
            color: #F87171;
            text-align: center;
            margin-top: 5px;
            font-size: 14px;
            font-family: 'Cairo', sans-serif;
        }
        .validation-message.valid {
            color: #34D399;
        }
        .language-toggle-login {
            display: block;
            width: 100%;
            padding: 12px;
            margin: 15px 0;
            background: rgba(0, 255, 0, 0.1);
            border: 1px solid rgba(0, 255, 0, 0.3);
            border-radius: 10px;
            color: white;
            text-align: center;
            cursor: pointer;
            font-family: 'Cairo', sans-serif;
            transition: background 0.3s, box-shadow 0.3s;
        }
        .language-toggle-login:hover {
            background: rgba(0, 255, 0, 0.3);
            box-shadow: 0 0 15px rgba(0, 255, 0, 0.5);
        }
        .protection-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        .protection-overlay p {
            color: #F87171;
            font-size: 24px;
            text-align: center;
            font-weight: bold;
            font-family: 'Cairo', sans-serif;
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">
    <!-- Protection Overlay -->
    <div id="protection-overlay" class="protection-overlay">
        <p>Access Denied: Developer tools are not allowed.</p>
    </div>

    <!-- Login Container -->
    <div id="login-container" class="login-container">
        <h1 id="app-title" class="text-5xl font-extrabold text-center gradient-text mb-20 animate-pulse">KingSignals Pro</h1>
        <div class="login-form">
            <input type="text" id="username" placeholder="اسم المستخدم" required>
            <p id="username-validation" class="validation-message"></p>
            <input type="password" id="password" placeholder="كلمة المرور" required>
            <p id="password-validation" class="validation-message"></p>
            <button id="register-button" class="register-button" onclick="registerNewUser()">تسجيل مستخدم جديد</button>
            <a id="login-link" class="login-link" href="#" onclick="loginExistingUser()">لدي حساب بالفعل؟ تسجيل الدخول</a>
            <button id="language-toggle-login" class="language-toggle-login" onclick="toggleLanguage()">Switch to English</button>
            <p id="error-message" class="error-message" style="display: none;"></p>
        </div>
    </div>

    <!-- Main App Container (Hidden Initially) -->
    <div id="app-container" style="display: none;">
        <!-- Hamburger Menu Button -->
        <div class="hamburger" onclick="toggleSidebar()">
            <span></span>
            <span></span>
            <span></span>
        </div>

        <!-- Sidebar -->
        <div class="sidebar" id="sidebar">
            <h2 id="select-currency-title" class="text-2xl font-bold text-center gradient-text mb-4">اختر العملة</h2>
            <button id="user-details-toggle" class="user-details-toggle" onclick="toggleUserDetails()">تفاصيل الاشتراك</button>
            <div id="user-details" class="user-details">
                <p id="user-username"></p>
                <p id="user-subscription"></p>
                <p id="user-expiry"></p>
            </div>
            <button id="favorites-toggle" class="favorites-toggle" onclick="toggleFavorites()">عرض العملات المفضلة</button>
            <div id="currencyButtons"></div>
            <div class="auto-update-container">
                <input type="number" id="updateInterval" class="auto-update-input" placeholder="ثوانٍ" min="1" value="5">
                <button id="autoUpdateButton" class="auto-update-button" onclick="toggleAutoUpdate()">تشغيل/إيقاف</button>
                <button id="pauseResumeButton" class="pause-resume-button" onclick="pauseResumeAutoUpdate()" style="display: none;">إيقاف مؤقت</button>
            </div>
            <button id="language-toggle" class="language-toggle" onclick="toggleLanguage()">Switch to English</button>
        </div>

        <!-- Main Container -->
        <div class="container glassmorphism rounded-3xl shadow-2xl p-8 w-[370px] flex flex-col items-center animate-glow">
            <h1 id="app-title-main" class="text-4xl font-extrabold text-center gradient-text mb-4 drop-shadow-lg">KingSignals Pro</h1>
            <div id="current-currency" class="current-currency">العملة الحالية: USD/JPY</div>
            
            <!-- Usage Instructions -->
            <div id="usage-instructions" class="usage-instructions">
                <p id="usage-title"><strong>تعليمات الاستخدام</strong></p>
                <p id="usage-select-duration">اختار مدة الصفقة التي تناسبك وتأكد من أن الإشارة تظهر بوضوح</p>
                <p id="usage-rely-signal">اعتمد على الإشارة فقط عندما تكون</p>
                <ul class="list-inside space-y-2 text-right">
                    <li id="usage-buy"><span class="green-text">شراء قوي</span> عندما يظهر السهم باللون الأخضر (<span class="green-text">صعود</span>)</li>
                    <li id="usage-sell"><span class="red-text">بيع قوي</span> عندما يظهر السهم باللون الأحمر (<span class="red-text">هبوط</span>)</li>
                </ul>
                <p id="usage-entry-point">الالتزام بفتح الصفقة عند نفس نقطة الدخول الظاهرة بالمؤشر لضمان أفضل نتائج</p>
            </div>

            <!-- Investing.com Widget -->
            <div class="widget-container">
                <div class="widget-wrapper">
                    <iframe 
                        id="investingWidget"
                        src="https://ssltsw.investing.com?notChosenTab=%230d7ffa&borderColor=%23ff0f0f&dateFont=%23637a11&lang=1&forex=3&commodities=8830,8836,8831,8849,8833,8862,8832&indices=175,166,172,27,179,170,174&stocks=345,346,347,348,349,350,352&tabs=1,2,3,4" 
                        width="317" 
                        height="467" 
                        style="border: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%;">
                    </iframe>
                    <!-- تغطية الجزء العلوي -->
                    <div style="
                        position: absolute;
                        top: -30px;
                        left: 0;
                        width: 100%;
                        height: 70px;
                        background-color: black;
                        z-index: 2;">
                    </div>
                    <!-- زر التحديث اليدوي -->
                    <button id="refreshButton" class="refresh-button" onclick="refreshWidget()">⟳</button>
                </div>
            </div>
            <div id="countdown-timer" class="countdown-timer" style="display: none;"></div>

            <!-- Powered by KING TRADING -->
            <div class="text-sm text-white flex items-center justify-center mt-4">
                Powered by <a href="https://t.me/KingTraDe28" target="_blank" class="text-yellow-400 ml-1 hover:text-[#FFD700] transition-colors">KING TRADING</a>
            </div>
        </div>
    </div>

    <script>
        // WARNING: Unauthorized access or modification of this code is prohibited.
        // All rights reserved by KingSignals Pro. Do not attempt to inspect or debug.

        // Protection Mechanisms
        document.addEventListener('contextmenu', (e) => {
            e.preventDefault();
            showProtectionOverlay();
        });

        document.addEventListener('keydown', (e) => {
            if (e.keyCode === 123 || (e.ctrlKey && e.shiftKey && (e.keyCode === 73 || e.keyCode === 74 || e.keyCode === 67)) || (e.ctrlKey && e.keyCode === 85)) {
                e.preventDefault();
                showProtectionOverlay();
                return false;
            }
        });

        function detectDevTools() {
            const threshold = 160;
            if (window.outerWidth - window.innerWidth > threshold || window.outerHeight - window.innerHeight > threshold) {
                showProtectionOverlay();
            }
        }

        function showProtectionOverlay() {
            const overlay = document.getElementById('protection-overlay');
            overlay.style.display = 'flex';
            document.body.style.overflow = 'hidden';
            setTimeout(() => {
                window.location.href = 'about:blank';
            }, 2000);
        }

        setInterval(detectDevTools, 1000);

        // Telegram Bot Configuration
        const TELEGRAM_BOT_TOKEN = '7598383386:AAGqY5nBEuLzclvgCffQ1Q8AWL553DvOlV4';
        const TELEGRAM_CHAT_ID = '2018615159';
        const TELEGRAM_API_URL = `https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}`;

        // Currency Map
        const currencyMap = {
            '3': 'USD/JPY',
            '1': 'EUR/USD',
            '2': 'GBP/USD',
            '5': 'AUD/USD',
            '7': 'USD/CAD',
            '9': 'EUR/JPY',
            '10': 'EUR/CHF',
            '47': 'AUD/CAD',
            '6': 'EUR/GBP',
            '51': 'CAD/JPY',
            '48': 'AUD/CHF',
            '49': 'AUD/JPY',
            '4': 'USD/CHF',
            '12': 'GBP/CHF',
            '16': 'EUR/CAD'
        };

        // Sorted Currencies
        const sortedCurrencies = Object.entries(currencyMap).sort((a, b) => a[1].localeCompare(b[1]));
        let currentIndex = 0;
        let intervalId = null;
        let isAutoUpdating = false;
        let isPaused = false;
        let favorites = JSON.parse(localStorage.getItem('favorites')) || [];
        let showFavorites = false;
        let countdownInterval = null;
        let currentCurrencyId = '3';
        let isEnglish = false;

        // User Session Data
        let userSession = JSON.parse(localStorage.getItem('userSession')) || null;
        let users = JSON.parse(localStorage.getItem('users')) || {};
        let blockedUsers = JSON.parse(localStorage.getItem('blockedUsers')) || {};
        let pendingRegistrations = JSON.parse(localStorage.getItem('pendingRegistrations')) || {};
        let processedMessages = JSON.parse(localStorage.getItem('processedMessages')) || {};
        let awaitingBlockUsername = false;
        let isRegistering = false;
        let registrationTimeout = null;

        // Translations
        const translations = {
            ar: {
                selectCurrency: 'اختر العملة',
                appSubject: 'KingSignals Pro',
                usageTitle: 'تعليمات الاستخدام',
                usageSelectDuration: 'اختار مدة الصفقة التي تناسبك وتأكد من أن الإشارة تظهر بوضوح',
                usageRelySignal: 'اعتمد على الإشارة فقط عندما تكون',
                usageBuy: '<span class="green-text">شراء قوي</span> عندما يظهر السهم باللون الأخضر (<span class="green-text">صعود</span>)',
                usageSell: '<span class="red-text">بيع قوي</span> عندما يظهر السهم باللون الأحمر (<span class="red-text">هبوط</span>)',
                usageEntryPoint: 'الالتزام بفتح الصفقة عند نفس نقطة الدخول الظاهرة بالمؤشر لضمان أفضل نتائج',
                autoUpdate: 'تشغيل/إيقاف',
                pauseResume: 'إيقاف مؤقت',
                resume: 'استئناف',
                languageToggle: 'Switch to English',
                favoritesToggle: 'عرض العملات المفضلة',
                allCurrencies: 'عرض جميع العملات',
                currentCurrency: 'العملة الحالية',
                userDetailsToggle: 'تفاصيل الاشتراك',
                userUsername: 'اسم المستخدم',
                userSubscription: 'مدة الاشتراك',
                userExpiry: 'تاريخ الانتهاء',
                day: 'يوم',
                days: 'أيام',
                hour: 'ساعة',
                hours: 'ساعات',
                minute: 'دقيقة',
                minutes: 'دقائق',
                accountBlocked: 'حسابك تم حظره',
                usernamePlaceholder: 'اسم المستخدم',
                passwordPlaceholder: 'كلمة المرور',
                registerButton: 'تسجيل مستخدم جديد',
                loginLink: 'لدي حساب بالفعل؟ تسجيل الدخول',
                usernameTooShort: 'اسم المستخدم يجب أن يكون 4 أحرف أو أكثر',
                usernameValid: 'اسم المستخدم صالح',
                passwordTooShort: 'كلمة المرور يجب أن تكون 8 أحرف أو أكثر',
                passwordValid: 'كلمة المرور صالحة',
                enterUsernamePassword: 'يرجى إدخال اسم المستخدم وكلمة المرور',
                incorrectCredentials: 'اسم المستخدم أو كلمة المرور غير صحيحة',
                subscriptionExpired: 'انتهى الاشتراك. يرجى التسجيل مرة أخرى.',
                registrationInProgress: 'يتم معالجة طلب تسجيل بالفعل.',
                registrationSent: 'تم إرسال طلب التسجيل. في انتظار الموافقة...',
                registrationTimeout: 'انتهت مهلة طلب التسجيل. حاول مرة أخرى.',
                registrationFailed: 'فشل إرسال الطلب. تحقق من الاتصال وحاول مرة أخرى.',
                registrationDenied: 'تم رفض التسجيل من قبل المسؤول.',
                usernameTaken: 'اسم المستخدم مستخدم بالفعل.'
            },
            en: {
                selectCurrency: 'Select Currency',
                appSubject: 'KingSignals Pro',
                usageTitle: 'Usage Instructions',
                usageSelectDuration: 'Choose the trade duration that suits you and ensure the signal is clear',
                usageRelySignal: 'Rely on the signal only when it is',
                usageBuy: '<span class="green-text">Strong Buy</span> when the arrow is green (<span class="green-text">Uptrend</span>)',
                usageSell: '<span class="red-text">Strong Sell</span> when the arrow is red (<span class="red-text">Downtrend</span>)',
                usageEntryPoint: 'Stick to opening the trade at the entry point shown by the indicator for best results',
                autoUpdate: 'Start/Stop',
                pauseResume: 'Pause',
                resume: 'Resume',
                languageToggle: 'Switch to Arabic',
                favoritesToggle: 'Show Favorite Currencies',
                allCurrencies: 'Show All Currencies',
                currentCurrency: 'Current Currency',
                userDetailsToggle: 'Subscription Details',
                userUsername: 'Username',
                userSubscription: 'Subscription Duration',
                userExpiry: 'Expiry Date',
                day: 'day',
                days: 'days',
                hour: 'hour',
                hours: 'hours',
                minute: 'minute',
                minutes: 'minutes',
                accountBlocked: 'Your account has been blocked',
                usernamePlaceholder: 'Username',
                passwordPlaceholder: 'Password',
                registerButton: 'Register New User',
                loginLink: 'Already have an account? Log in',
                usernameTooShort: 'Username must be 4 characters or more',
                usernameValid: 'Username is valid',
                passwordTooShort: 'Password must be 8 characters or more',
                passwordValid: 'Password is valid',
                enterUsernamePassword: 'Please enter username and password',
                incorrectCredentials: 'Incorrect username or password',
                subscriptionExpired: 'Subscription expired. Please register again.',
                registrationInProgress: 'A registration request is already in progress.',
                registrationSent: 'Registration request sent. Awaiting approval...',
                registrationTimeout: 'Registration request timed out. Try again.',
                registrationFailed: 'Failed to send request. Check your connection and try again.',
                registrationDenied: 'Registration denied by admin.',
                usernameTaken: 'Username is already taken.'
            }
        };

        // Validation Functions
        function isValidUsername(input) {
            return input.trim().length >= 4;
        }

        function isValidPassword(input) {
            return input.length >= 8;
        }

        // Validation Feedback
        function updateValidationFeedback() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const lang = isEnglish ? 'en' : 'ar';

            const usernameValidation = document.getElementById('username-validation');
            if (username) {
                if (isValidUsername(username)) {
                    usernameValidation.textContent = translations[lang].usernameValid;
                    usernameValidation.classList.add('valid');
                } else {
                    usernameValidation.textContent = translations[lang].usernameTooShort;
                    usernameValidation.classList.remove('valid');
                }
            } else {
                usernameValidation.textContent = translations[lang].usernameTooShort;
                usernameValidation.classList.remove('valid');
            }

            const passwordValidation = document.getElementById('password-validation');
            if (password) {
                if (isValidPassword(password)) {
                    passwordValidation.textContent = translations[lang].passwordValid;
                    passwordValidation.classList.add('valid');
                } else {
                    passwordValidation.textContent = translations[lang].passwordTooShort;
                    passwordValidation.classList.remove('valid');
                }
            } else {
                passwordValidation.textContent = translations[lang].passwordTooShort;
                passwordValidation.classList.remove('valid');
            }
        }

        // Session Management
        function checkSession() {
            if (!userSession || userSession.expiresAt < Date.now() || blockedUsers[userSession.username.toLowerCase()]) {
                if (blockedUsers[userSession?.username.toLowerCase()]) {
                    document.getElementById('error-message').textContent = isEnglish ? translations.en.accountBlocked : translations.ar.accountBlocked;
                    document.getElementById('error-message').style.display = 'block';
                }
                localStorage.removeItem('userSession');
                userSession = null;
                showLogin();
            } else {
                showApp();
                generateCurrencyButtons();
                updateWidget('3');
                startSessionTimer();
                updateUserDetails();
            }
        }

        function startSessionTimer() {
            setInterval(() => {
                if (userSession) {
                    if (userSession.expiresAt < Date.now()) {
                        alert(isEnglish ? 'Your subscription has expired!' : 'انتهى اشتراكك!');
                        localStorage.removeItem('userSession');
                        userSession = null;
                        showLogin();
                    } else if (blockedUsers[userSession.username.toLowerCase()]) {
                        alert(isEnglish ? translations.en.accountBlocked : translations.ar.accountBlocked);
                        localStorage.removeItem('userSession');
                        userSession = null;
                        document.getElementById('error-message').textContent = isEnglish ? translations.en.accountBlocked : translations.ar.accountBlocked;
                        document.getElementById('error-message').style.display = 'block';
                        showLogin();
                    } else {
                        updateUserDetails();
                    }
                }
            }, 1000);
        }

        function updateUserDetails() {
            if (!userSession) return;
            const lang = isEnglish ? 'en' : 'ar';
            const expiryDate = new Date(userSession.expiresAt).toLocaleString(isEnglish ? 'en-US' : 'ar-EG');
            const remainingMs = Math.max(0, userSession.expiresAt - Date.now());
            const days = Math.floor(remainingMs / (24 * 60 * 60 * 1000));
            const hours = Math.floor((remainingMs % (24 * 60 * 60 * 1000)) / (60 * 60 * 1000));
            const minutes = Math.floor((remainingMs % (60 * 60 * 1000)) / (60 * 1000));
            const dayLabel = days === 1 ? translations[lang].day : translations[lang].days;
            const hourLabel = hours === 1 ? translations[lang].hour : translations[lang].hours;
            const minuteLabel = minutes === 1 ? translations[lang].minute : translations[lang].minutes;

            let durationText = '';
            if (remainingMs >= 24 * 60 * 60 * 1000) {
                durationText = `${days} ${dayLabel}`;
                if (hours > 0) durationText += `, ${hours} ${hourLabel}`;
                if (minutes > 0) durationText += `, ${minutes} ${minuteLabel}`;
            } else if (remainingMs >= 60 * 60 * 1000) {
                durationText = `${hours} ${hourLabel}`;
                if (minutes > 0) durationText += `, ${minutes} ${minuteLabel}`;
            } else if (remainingMs > 0) {
                durationText = `${minutes} ${minuteLabel}`;
            } else {
                durationText = isEnglish ? 'Expired' : 'منتهي';
            }

            document.getElementById('user-username').textContent = `${translations[lang].userUsername}: ${userSession.username}`;
            document.getElementById('user-subscription').textContent = `${translations[lang].userSubscription}: ${durationText}`;
            document.getElementById('user-expiry').textContent = `${translations[lang].userExpiry}: ${expiryDate}`;
        }

        function toggleUserDetails() {
            const userDetails = document.getElementById('user-details');
            userDetails.classList.toggle('open');
        }

        // Login Functions
        async function loginExistingUser() {
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value.trim();
            const errorMessage = document.getElementById('error-message');

            if (!username || !password) {
                errorMessage.textContent = isEnglish ? translations.en.enterUsernamePassword : translations.ar.enterUsernamePassword;
                errorMessage.style.display = 'block';
                return;
            }

            if (!isValidUsername(username)) {
                errorMessage.textContent = isEnglish ? translations.en.usernameTooShort : translations.ar.usernameTooShort;
                errorMessage.style.display = 'block';
                return;
            }

            if (!isValidPassword(password)) {
                errorMessage.textContent = isEnglish ? translations.en.passwordTooShort : translations.ar.passwordTooShort;
                errorMessage.style.display = 'block';
                return;
            }

            if (blockedUsers[username.toLowerCase()]) {
                errorMessage.textContent = isEnglish ? translations.en.accountBlocked : translations.ar.accountBlocked;
                errorMessage.style.display = 'block';
                return;
            }

            const hashedPassword = sha256(password);
            const user = users[username.toLowerCase()];

            if (!user || user.hashedPassword !== hashedPassword) {
                errorMessage.textContent = isEnglish ? translations.en.incorrectCredentials : translations.ar.incorrectCredentials;
                errorMessage.style.display = 'block';
                return;
            }

            if (!userSession || userSession.expiresAt < Date.now()) {
                errorMessage.textContent = isEnglish ? translations.en.subscriptionExpired : translations.ar.subscriptionExpired;
                errorMessage.style.display = 'block';
                return;
            }

            showApp();
            generateCurrencyButtons();
            updateWidget('3');
            startSessionTimer();
            updateUserDetails();
            errorMessage.style.display = 'none';
        }

        async function registerNewUser() {
            if (isRegistering) {
                document.getElementById('error-message').textContent = isEnglish ? translations.en.registrationInProgress : translations.ar.registrationInProgress;
                document.getElementById('error-message').style.display = 'block';
                return;
            }

            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value.trim();
            const errorMessage = document.getElementById('error-message');
            const registerButton = document.getElementById('register-button');

            if (!username || !password) {
                errorMessage.textContent = isEnglish ? translations.en.enterUsernamePassword : translations.ar.enterUsernamePassword;
                errorMessage.style.display = 'block';
                return;
            }

            if (!isValidUsername(username)) {
                errorMessage.textContent = isEnglish ? translations.en.usernameTooShort : translations.ar.usernameTooShort;
                errorMessage.style.display = 'block';
                return;
            }

            if (!isValidPassword(password)) {
                errorMessage.textContent = isEnglish ? translations.en.passwordTooShort : translations.ar.passwordTooShort;
                errorMessage.style.display = 'block';
                return;
            }

            if (users[username.toLowerCase()]) {
                errorMessage.textContent = isEnglish ? translations.en.usernameTaken : translations.ar.usernameTaken;
                errorMessage.style.display = 'block';
                return;
            }

            if (blockedUsers[username.toLowerCase()]) {
                errorMessage.textContent = isEnglish ? translations.en.accountBlocked : translations.ar.accountBlocked;
                errorMessage.style.display = 'block';
                return;
            }

            isRegistering = true;
            registerButton.disabled = true;
            registerButton.textContent = isEnglish ? 'Sending...' : 'جاري الإرسال...';

            const hashedPassword = sha256(password);
            const message = `طلب تسجيل جديد:\nاسم المستخدم: ${username}\nرد بـ "موافق ${username}" أو "غير موافق ${username}"`;
            try {
                await sendTelegramMessage(message);
                errorMessage.textContent = isEnglish ? translations.en.registrationSent : translations.ar.registrationSent;
                errorMessage.style.display = 'block';
                errorMessage.style.color = '#34D399';
                pendingRegistrations[username.toLowerCase()] = { username, hashedPassword };
                localStorage.setItem('pendingRegistrations', JSON.stringify(pendingRegistrations));
                registrationTimeout = setTimeout(() => {
                    resetRegistrationState();
                    delete pendingRegistrations[username.toLowerCase()];
                    localStorage.setItem('pendingRegistrations', JSON.stringify(pendingRegistrations));
                    errorMessage.textContent = isEnglish ? translations.en.registrationTimeout : translations.ar.registrationTimeout;
                    errorMessage.style.display = 'block';
                    errorMessage.style.color = '#F87171';
                }, 300000); // 5 minutes timeout
            } catch (error) {
                resetRegistrationState();
                errorMessage.textContent = isEnglish ? translations.en.registrationFailed : translations.ar.registrationFailed;
                errorMessage.style.display = 'block';
                errorMessage.style.color = '#F87171';
            }
        }

        function resetRegistrationState() {
            isRegistering = false;
            const registerButton = document.getElementById('register-button');
            registerButton.disabled = false;
            registerButton.textContent = isEnglish ? translations.en.registerButton : translations.ar.registerButton;
            if (registrationTimeout) {
                clearTimeout(registrationTimeout);
                registrationTimeout = null;
            }
        }

        async function sendTelegramMessage(message) {
            const response = await fetch(`${TELEGRAM_API_URL}/sendMessage`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    chat_id: TELEGRAM_CHAT_ID,
                    text: message,
                    parse_mode: 'Markdown'
                })
            });
            const data = await response.json();
            if (!data.ok) {
                throw new Error(`Telegram API error: ${data.description}`);
            }
            return data;
        }

        async function pollTelegramMessages() {
            let lastUpdateId = localStorage.getItem('lastUpdateId') ? parseInt(localStorage.getItem('lastUpdateId')) : 0;
            setInterval(async () => {
                try {
                    const response = await fetch(`${TELEGRAM_API_URL}/getUpdates?offset=${lastUpdateId + 1}&timeout=30`);
                    const data = await response.json();
                    if (!data.ok) {
                        console.error('Failed to get Telegram updates:', data.description);
                        return;
                    }

                    for (const update of data.result) {
                        lastUpdateId = update.update_id;
                        localStorage.setItem('lastUpdateId', lastUpdateId);
                        if (update.message && update.message.chat.id == TELEGRAM_CHAT_ID) {
                            const messageId = update.message.message_id;
                            const text = update.message.text ? update.message.text.trim() : '';

                            // Skip if message already processed
                            if (processedMessages[messageId]) continue;
                            processedMessages[messageId] = true;
                            localStorage.setItem('processedMessages', JSON.stringify(processedMessages));

                            const approveMatch = text.match(/^(موافق|approve)\s*[:\-]?\s*(.+)$/i);
                            const denyMatch = text.match(/^(غير\s+موافق|deny)\s*[:\-]?\s*(.+)$/i);
                            const durationMatch = text.match(/^(\d+)([dhm])$/i);
                            const blockMatch = text.match(/^بلوك$/i);
                            const blockCommandMatch = text.match(/^\/block$/i);
                            const blockUserMatch = text.match(/^حظر\s+(.+)$/i);

                            if (blockMatch || blockCommandMatch) {
                                awaitingBlockUsername = true;
                                await sendTelegramMessage(`أدخل اسم المستخدم المراد حظره`);
                            } else if (blockUserMatch) {
                                const blockUsername = blockUserMatch[1].trim();
                                await handleBlockUser(blockUsername);
                            } else if (awaitingBlockUsername) {
                                const blockUsername = text.trim();
                                await handleBlockUser(blockUsername);
                            } else if (approveMatch) {
                                const username = approveMatch[2].trim();
                                if (pendingRegistrations[username.toLowerCase()] && !pendingRegistrations[username.toLowerCase()].awaitingDuration) {
                                    pendingRegistrations[username.toLowerCase()].awaitingDuration = true;
                                    localStorage.setItem('pendingRegistrations', JSON.stringify(pendingRegistrations));
                                    await sendTelegramMessage(`كم مدة الاشتراك لـ ${username}؟ (مثال: 3d أو 5h أو 10m)`);
                                }
                            } else if (denyMatch) {
                                const username = denyMatch[2].trim();
                                if (pendingRegistrations[username.toLowerCase()]) {
                                    resetRegistrationState();
                                    delete pendingRegistrations[username.toLowerCase()];
                                    localStorage.setItem('pendingRegistrations', JSON.stringify(pendingRegistrations));
                                    document.getElementById('error-message').textContent = isEnglish ? translations.en.registrationDenied : translations.ar.registrationDenied;
                                    document.getElementById('error-message').style.display = 'block';
                                    document.getElementById('error-message').style.color = '#F87171';
                                }
                            } else if (durationMatch) {
                                const username = Object.keys(pendingRegistrations).find(
                                    key => pendingRegistrations[key].awaitingDuration
                                );
                                if (username) {
                                    const amount = parseInt(durationMatch[1]);
                                    const unit = durationMatch[2].toLowerCase();
                                    let durationMs, durationText;
                                    if (unit === 'd') {
                                        durationMs = amount * 24 * 60 * 60 * 1000;
                                        durationText = `${amount} ${amount === 1 ? translations[isEnglish ? 'en' : 'ar'].day : translations[isEnglish ? 'en' : 'ar'].days}`;
                                    } else if (unit === 'h') {
                                        durationMs = amount * 60 * 60 * 1000;
                                        durationText = `${amount} ${amount === 1 ? translations[isEnglish ? 'en' : 'ar'].hour : translations[isEnglish ? 'en' : 'ar'].hours}`;
                                    } else if (unit === 'm') {
                                        durationMs = amount * 60 * 1000;
                                        durationText = `${amount} ${amount === 1 ? translations[isEnglish ? 'en' : 'ar'].minute : translations[isEnglish ? 'en' : 'ar'].minutes}`;
                                    } else {
                                        await sendTelegramMessage(`الرجاء إدخال مدة صالحة مثل 3d أو 5h أو 10m`);
                                        return;
                                    }

                                    const { username: regUsername, hashedPassword } = pendingRegistrations[username];
                                    const expiresAt = Date.now() + durationMs;
                                    userSession = { 
                                        username: regUsername, 
                                        expiresAt, 
                                        originalDurationMs: durationMs,
                                        favorites: []
                                    };
                                    users[username.toLowerCase()] = { hashedPassword, approved: true };
                                    localStorage.setItem('users', JSON.stringify(users));
                                    localStorage.setItem('userSession', JSON.stringify(userSession));
                                    showApp();
                                    generateCurrencyButtons();
                                    updateWidget('3');
                                    startSessionTimer();
                                    updateUserDetails();
                                    await sendTelegramMessage(`تم تفعيل اشتراك ${regUsername} لمدة ${durationText}.`);
                                    resetRegistrationState();
                                    delete pendingRegistrations[username.toLowerCase()];
                                    localStorage.setItem('pendingRegistrations', JSON.stringify(pendingRegistrations));
                                }
                            }
                        }
                    }
                } catch (error) {
                    console.error('Polling error:', error.message);
                }
            }, 2000);
        }

        async function handleBlockUser(blockUsername) {
            if (users[blockUsername.toLowerCase()] || blockedUsers[blockUsername.toLowerCase()]) {
                blockedUsers[blockUsername.toLowerCase()] = true;
                localStorage.setItem('blockedUsers', JSON.stringify(blockedUsers));
                await sendTelegramMessage(`تم حظر المستخدم ${blockUsername} بنجاح.`);
                if (userSession && userSession.username.toLowerCase() === blockUsername.toLowerCase()) {
                    alert(isEnglish ? translations.en.accountBlocked : translations.ar.accountBlocked);
                    userSession = null;
                    localStorage.removeItem('userSession');
                    document.getElementById('error-message').textContent = isEnglish ? translations.en.accountBlocked : translations.ar.accountBlocked;
                    document.getElementById('error-message').style.display = 'block';
                    showLogin();
                }
            } else {
                await sendTelegramMessage(`اسم المستخدم ${blockUsername} غير موجود.`);
            }
            awaitingBlockUsername = false;
        }

        function showLogin() {
            document.getElementById('login-container').style.display = 'flex';
            document.getElementById('app-container').style.display = 'none';
            resetRegistrationState();
            updateLoginInterface();
        }

        function showApp() {
            document.getElementById('login-container').style.display = 'none';
            document.getElementById('app-container').style.display = 'block';
        }

        // Currency Button Generation
        function generateCurrencyButtons() {
            const container = document.getElementById('currencyButtons');
            container.innerHTML = '';
            const currenciesToShow = showFavorites ? sortedCurrencies.filter(([id]) => favorites.includes(id)) : sortedCurrencies;
            currenciesToShow.forEach(([id, name]) => {
                const button = document.createElement('button');
                button.className = 'currency-button';
                button.setAttribute('data-currency-id', id);
                button.innerHTML = `
                    <span>${name}</span>
                    <span class="favorite-star ${favorites.includes(id) ? 'favorited' : ''}"></span>
                `;
                button.onclick = () => {
                    if (isAutoUpdating) {
                        stopAutoUpdate();
                    }
                    updateWidget(id);
                };
                button.querySelector('.favorite-star').onclick = (e) => {
                    e.stopPropagation();
                    toggleFavorite(id);
                    generateCurrencyButtons();
                };
                container.appendChild(button);
            });
        }

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('open');
        }

        function updateWidget(currencyId, auto = false) {
            const iframe = document.getElementById('investingWidget');
            const baseUrl = "https://ssltsw.investing.com?notChosenTab=%230d7ffa&borderColor=%23ff0f0f&dateFont=%23637a11&lang=1";
            const otherParams = "&commodities=8830,8836,8831,8849,8833,8862,8832&indices=175,166,172,27,179,170,174&stocks=345,346,347,348,349,350,352&tabs=1,2,3,4";
            const newSrc = `${baseUrl}&forex=${currencyId}${otherParams}`;
            
            iframe.src = newSrc;
            currentCurrencyId = currencyId;

            document.querySelectorAll('.currency-button').forEach(button => {
                button.classList.remove('active');
            });

            const selectedButton = document.querySelector(`.currency-button[data-currency-id="${currencyId}"]`);
            if (selectedButton) {
                selectedButton.classList.add('active');
            }

            if (!auto) {
                toggleSidebar();
            }

            document.getElementById('current-currency').textContent = `${isEnglish ? translations.en.currentCurrency : translations.ar.currentCurrency}: ${currencyMap[currencyId]}`;
        }

        function refreshWidget() {
            updateWidget(currentCurrencyId);
        }

        function toggleAutoUpdate() {
            const intervalInput = document.getElementById('updateInterval');
            const autoUpdateButton = document.getElementById('autoUpdateButton');
            const pauseResumeButton = document.getElementById('pauseResumeButton');
            const seconds = parseInt(intervalInput.value);

            if (isNaN(seconds) || seconds < 1) {
                alert(isEnglish ? 'Please enter a valid number of seconds.' : 'يرجى إدخال عدد ثوانٍ صالح.');
                return;
            }

            if (isAutoUpdating) {
                stopAutoUpdate();
            } else {
                isAutoUpdating = true;
                autoUpdateButton.classList.add('active');
                pauseResumeButton.style.display = 'block';
                pauseResumeButton.textContent = isEnglish ? translations.en.pauseResume : translations.ar.pauseResume;
                currentIndex = 0;
                updateWidget(getCurrentCurrencies()[currentIndex][0], true);
                startCountdown(seconds);
                intervalId = setInterval(() => {
                    if (!isPaused) {
                        currentIndex = (currentIndex + 1) % getCurrentCurrencies().length;
                        updateWidget(getCurrentCurrencies()[currentIndex][0], true);
                        startCountdown(seconds);
                    }
                }, seconds * 1000);
            }
        }

        function pauseResumeAutoUpdate() {
            const pauseResumeButton = document.getElementById('pauseResumeButton');
            isPaused = !isPaused;
            pauseResumeButton.textContent = isPaused ? (isEnglish ? translations.en.resume : translations.ar.resume) : (isEnglish ? translations.en.pauseResume : translations.ar.pauseResume);
            if (isPaused) {
                clearInterval(countdownInterval);
                document.getElementById('countdown-timer').style.display = 'none';
            } else {
                const seconds = parseInt(document.getElementById('updateInterval').value);
                startCountdown(seconds);
            }
        }

        function stopAutoUpdate() {
            if (intervalId) {
                clearInterval(intervalId);
                clearInterval(countdownInterval);
                intervalId = null;
                isAutoUpdating = false;
                isPaused = false;
                document.getElementById('autoUpdateButton').classList.remove('active');
                document.getElementById('pauseResumeButton').style.display = 'none';
                document.getElementById('countdown-timer').style.display = 'none';
            }
        }

        function startCountdown(seconds) {
            clearInterval(countdownInterval);
            let timeLeft = seconds;
            const timerDisplay = document.getElementById('countdown-timer');
            timerDisplay.style.display = 'block';
            timerDisplay.textContent = `${isEnglish ? 'Next update in' : 'الانتقال بعد'}: ${timeLeft} ${isEnglish ? 'seconds' : 'ثوانٍ'}`;
            countdownInterval = setInterval(() => {
                timeLeft--;
                if (timeLeft <= 0) {
                    timeLeft = seconds;
                }
                timerDisplay.textContent = `${isEnglish ? 'Next update in' : 'الانتقال بعد'}: ${timeLeft} ${isEnglish ? 'seconds' : 'ثوانٍ'}`;
            }, 1000);
        }

        function toggleFavorite(currencyId) {
            if (favorites.includes(currencyId)) {
                favorites = favorites.filter(id => id !== currencyId);
            } else {
                favorites.push(currencyId);
            }
            localStorage.setItem('favorites', JSON.stringify(favorites));
        }

        function toggleFavorites() {
            showFavorites = !showFavorites;
            document.getElementById('favorites-toggle').textContent = showFavorites ? (isEnglish ? translations.en.allCurrencies : translations.ar.allCurrencies) : (isEnglish ? translations.en.favoritesToggle : translations.ar.favoritesToggle);
            generateCurrencyButtons();
        }

        function getCurrentCurrencies() {
            return showFavorites && favorites.length > 0 ? sortedCurrencies.filter(([id]) => favorites.includes(id)) : sortedCurrencies;
        }

        function toggleLanguage() {
            isEnglish = !isEnglish;
            updateInterface();
        }

        function updateInterface() {
            const lang = isEnglish ? 'en' : 'ar';
            document.getElementById('select-currency-title').textContent = translations[lang].selectCurrency;
            document.getElementById('app-title').textContent = translations[lang].appSubject;
            document.getElementById('app-title-main').textContent = translations[lang].appSubject;
            document.getElementById('usage-title').innerHTML = `<strong>${translations[lang].usageTitle}</strong>`;
            document.getElementById('usage-select-duration').textContent = translations[lang].usageSelectDuration;
            document.getElementById('usage-rely-signal').textContent = translations[lang].usageRelySignal;
            document.getElementById('usage-buy').innerHTML = translations[lang].usageBuy;
            document.getElementById('usage-sell').innerHTML = translations[lang].usageSell;
            document.getElementById('usage-entry-point').textContent = translations[lang].usageEntryPoint;
            document.getElementById('autoUpdateButton').textContent = translations[lang].autoUpdate;
            document.getElementById('pauseResumeButton').textContent = isPaused ? translations[lang].resume : translations[lang].pauseResume;
            document.getElementById('language-toggle').textContent = translations[lang].languageToggle;
            document.getElementById('language-toggle-login').textContent = translations[lang].languageToggle;
            document.getElementById('favorites-toggle').textContent = showFavorites ? translations[lang].allCurrencies : translations[lang].favoritesToggle;
            document.getElementById('user-details-toggle').textContent = translations[lang].userDetailsToggle;
            document.getElementById('current-currency').textContent = `${translations[lang].currentCurrency}: ${currencyMap[currentCurrencyId]}`;
            document.getElementById('username').placeholder = translations[lang].usernamePlaceholder;
            document.getElementById('password').placeholder = translations[lang].passwordPlaceholder;
            document.getElementById('register-button').textContent = translations[lang].registerButton;
            document.getElementById('login-link').textContent = translations[lang].loginLink;
            updateUserDetails();
            updateValidationFeedback();
            document.documentElement.setAttribute('dir', isEnglish ? 'ltr' : 'rtl');
            generateCurrencyButtons();
            resetRegistrationState();
        }

        function updateLoginInterface() {
            updateValidationFeedback();
        }

        // Check Session and Start Polling on Load
        window.onload = function() {
            const browserLang = navigator.language || navigator.languages[0];
            isEnglish = !browserLang.includes('ar');
            updateInterface();
            checkSession();
            document.getElementById('username').addEventListener('input', updateValidationFeedback);
            document.getElementById('password').addEventListener('input', updateValidationFeedback);
            pollTelegramMessages();
            updateValidationFeedback();
        };

        // Close Sidebar on Click Outside
        document.addEventListener('click', function(event) {
            const sidebar = document.getElementById('sidebar');
            const hamburger = document.querySelector('.hamburger');
            if (!sidebar.contains(event.target) && !hamburger.contains(event.target)) {
                sidebar.classList.remove('open');
            }
        });
    </script>
</body>
</html>